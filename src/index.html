<!DOCTYPE html>
<html>
	<head>
		<title>MyPlayer</title>
		<link rel="stylesheet" href="node_modules/font-awesome/css/font-awesome.min.css">
		<style>
			* {
				margin: 0;
				padding: 0;
				user-select: none;
				-webkit-touch-callout: none;
				-webkit-user-select: none;
				font-family: Helvetica;
			}
			body{
				background-color: #1E1E1E;
				height: 100%;
				overflow: hidden;
				font-size: 16px;
			}
			#wave {
				width: 600px; 
				height: 128px;
				border-bottom: 1px solid #424242;
			}
			.buttons {
				float: left;
				padding: 0px;
				width: 190px;
			}
			.buttons a {
				color: #E2E2E2;
				display: inline-block;
				padding: 15px 15px;
				background-color: #424242;
				cursor: pointer;
				float: left;
				margin-right: 1px;
			}
			.meta {
				font-size: 10px;
				line-height: 1.3em;
				float: left;
				height: 39px;
				color: #E2E2E2;
				padding: 5px;
				background-color: rgba(153, 153, 153, 0.12);
				width: 394px;
				overflow: hidden;

			}
			.meta .id3 span.metatags {
				white-space: nowrap;
				text-overflow: ellipsis;
			} 
			.meta .fileinfo {
				overflow: hidden;
				opacity: 0.5;
			}
			.meta .fileinfo span.path {
				white-space: nowrap;
				text-overflow: ellipsis;
			} 
		</style>
	</head>
	<body>
	<div 
		id="wave">
	</div>
	<div class="buttons">
		<a class="openFile" onclick="openfile()"><i class="fa fa-file-audio-o"></i></a>
		<a class="play" onclick="replay()"><i class="fa fa-share"></i></a>
		<a class="play" onclick="playpause()"><i class="fa fa-play"></i><i class="fa fa-pause"></i></a>
		<a class="skip" onclick="skip()"><i class="fa fa-step-forward"></i></a>
	</div>
	<div class="meta">
		<div class="timing">
			<span class="display_pos"></span>
			<i class="fa fa-arrow-right"></i> 
			<span class="display_length"></span>
		</div>
		<div class="id3">
			<span class="metatags">
				no song loaded ...
			</span>
		</div>
		<div class="fileinfo">
			<span class="path"></span>
		</div>
	</div>
	</body>
	<script type="text/javascript" src="node_modules/wavesurfer.js/dist/wavesurfer.min.js"></script>
	<script type="text/javascript">
		var remote = require('remote');
		var fs = require("fs");
		var _ = require("lodash");
		var pathHelper = require("path");
		var dialog = remote.require('dialog');
		var ipc = require('ipc');
		var playlist = [];
		var playlistPosition = false;
		var currentFile = false;
		var recursiveSync = require("recursive-readdir-sync");
		var id3 = require("id3js");

		/**
		 * Converts a buffer into an ArrayBuffer
		 * needed to convert read files to blobs
		 * for WaveSurfer
		 * 
		 * @author Robert Agthe <robert@scriptshit.de
		 * @param  {string} buffer string of binary data
		 * @return {array} Array Buffer
		 */
		function toArrayBuffer(buffer) {
			var ab = new ArrayBuffer(buffer.length);
			var view = new Uint8Array(ab);
			for (var i = 0; i < buffer.length; ++i) {
				view[i] = buffer[i];
			}
			return ab;
		}

		/**
		 * Load binary from the filesystem and send it 
		 * to generate a blob.
		 * 
		 * @author Robert Agthe <robert@scriptshit.de
		 * @param  {[type]} file [description]
		 * @return {[type]}      [description]
		 */
		var loadBinary = function(file){
			var binary = fs.readFileSync(file);
			return new Blob( [toArrayBuffer(binary)]);
		};

		/**
		 * User submits a mp3, we search for more
		 * mp3s in this directory to have a nice play
		 * list!
		 * @author Robert Agthe <robert@scriptshit.de
		 * @return {[type]} [description]
		 */
		var searchForMoreMP3inThisDir = function(path){
			// get the path to the parent dir of this file path
			var parentPath = pathHelper.dirname(path);
			// read this dir and all sub-dirs
			var files = recursiveSync(parentPath);
			// filter: only audio files we can listen to
			var audioFiles = _.filter(files, function(n){
				return /(?:\.mp3$)|(?:\.wav$)|(?:\.m4a$)/.test(n);
			});
			return {
				filteredDir: audioFiles,
				path: parentPath
			};
		};

		var createPlaylist = function(path){
			var music = searchForMoreMP3inThisDir(path);
			playlist = [];
			_.each(music.filteredDir, function(file){
				playlist.push(file);
			});
			playlistPosition = _.findIndex(playlist, function(file){
				return currentFile == file;
			});
			console.log("Playlist created!", playlist, playlistPosition, currentFile);
		};

		// Init Wavesurfer
		var wavesurfer = Object.create(WaveSurfer);
		wavesurfer.init({
			container: '#wave',
			waveColor: '#424242',
			progressColor: '#999',
			cursorColor: '#F82A71'
		});

		/**
		 * Event: Wavesurfer loaded a new track and is 
		 * ready to play... start play the song!
		 * 
		 * @author Robert Agthe <robert@scriptshit.de
		 */
		wavesurfer.on('ready', function(){
			elPos = document.querySelector(".display_length");
			elPos.textContent = (wavesurfer.getDuration()/60).toFixed(2).replace(".",":");
			wavesurfer.play();
		});

		wavesurfer.on('finish', function(){
			if(playlist && playlist.length > 0){
				skip();
			}
		});

		/**
		 * Event: User OS wants to use the application to open a file
		 * @author Robert Agthe <robert@scriptshit.de
		 * @param  {[type]} event [description]
		 * @return {[type]} [description]
		 */
		ipc.on("open-file", function(path) {
			// load file, and play
			loadtune(path);
		});

		/**
		 * Events for the UI
		 * @author Robert Agthe <robert@scriptshit.de
		 */

		/**
		 * Event: User wants to open a new file,
		 * clicked on the "open file" icon!
		 * @author Robert Agthe <robert@scriptshit.de
		 */
		var openfile = function(){
			dialog.showOpenDialog(
				{ filters: [{ name: 'Audio', extensions: ['mp3','m4a','wav'] }]}, 
				function (fileNames) {
					if (fileNames === undefined) return;
					loadtune(fileNames[0]);
			}); 
		};

		/**
		 * Event: Play Pause Button pressed
		 * User wants to stop the song at the current position
		 * or continue playing
		 * 
		 * @author Robert Agthe <robert@scriptshit.de
		 */
		var playpause = function(){
			wavesurfer.playPause();
		};

		/**
		 * Event: Replay button pressed
		 * User wants to start playing from the beginning
		 * 
		 * @author Robert Agthe <robert@scriptshit.de
		 */
		var replay = function(){
			wavesurfer.play(0);
		};

		var skip = function(){
			playlistPosition++;
			if((playlistPosition+1) > playlist.length){
				playlistPosition = 0;
			}
			var newMusicFilePath = playlist[playlistPosition];
			loadtune(newMusicFilePath);
		};

		var loadtune = function(file){
			// remember globally file
			currentFile = file;
			// read id3 Tag from current loading tune!
			currentId3 = id3({file: currentFile, type: id3.OPEN_LOCAL }, function(err, tags){
				// ui update
				var elMetatags = document.querySelector(".metatags");
				// display only available tags
				if(tags.artist && tags.artist !== ""){
					elMetatags.textContent = tags.artist+ " - "+ tags.title;
				} else {
					elMetatags.textContent = tags.title;
				}
			});
			// display filename and path
			var elFileinfo = document.querySelector(".fileinfo .path");
			var filename = currentFile.substr(-40);
			elFileinfo.textContent = "... " + filename;

			// load blob
			//wavesurfer.load("file:///"+file);
			wavesurfer.loadBlob(loadBinary(currentFile));
			// create a playlist from the parent dir
			createPlaylist(currentFile);
		};

		/**
		 * Update constantly the current play position
		 * @author Robert Agthe <robert@scriptshit.de
		 */
		setInterval(function(){
			var currentTime = wavesurfer.getCurrentTime();
			var elPos = document.querySelector(".display_pos");
			elPos.textContent = (currentTime/60).toFixed(2).replace(".",":");
		}, 100);
		// init 0 length / no tune loaded
		var elLen = document.querySelector(".display_length");
		elLen.textContent = "0:00";

		/**
		 * Define Drag & Drop Events
		 */
		var holder = document.querySelector('body');

		holder.ondragover = function () {
			return false;
		};
		holder.ondragleave = holder.ondragend = function () {
			return false;
		};
		holder.ondrop = function (e) {
			e.preventDefault();
			var file = e.dataTransfer.files[0];
			loadtune(file.path);
			return false;
		};


		// Load on startup...
		// path to music file to load
		// user opens the app with a file
		// get the path to the file from the backend 
		// remote process ...
		var loadOnStartup = remote.getGlobal("loadOnStartup");
		if(loadOnStartup){
			// load file, and play
			loadtune(loadOnStartup);
		}

		</script>
</html>